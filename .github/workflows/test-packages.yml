name: Test Package Startup

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'packages/**'
      - '.github/workflows/test-packages.yml'
      - 'package.json'
      - 'package-lock.json'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'packages/**'
      - '.github/workflows/test-packages.yml'
      - 'package.json'
      - 'package-lock.json'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Determine which packages have changes
  detect-changes:
    name: Detect Package Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      admin-panel: ${{ steps.filter.outputs.admin-panel }}
      mobile-app: ${{ steps.filter.outputs.mobile-app }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'packages/backend/**'
              - 'packages/shared/**'
            admin-panel:
              - 'packages/admin-panel/**'
              - 'packages/shared/**'
            mobile-app:
              - 'packages/mobile-app/**'
              - 'packages/shared/**'

  # Backend startup build check
  test-backend:
    name: Test Backend Startup
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build backend
        run: npm run build:backend

      - name: Test backend startup
        timeout-minutes: 2
        run: |
          # Create minimal .env for testing
          cat > packages/backend/.env << EOF
          PORT=3000
          HOST=localhost
          NODE_ENV=test
          DATABASE_URL=postgresql://test:test@localhost:5432/testdb
          DB_HOST=localhost
          DB_PORT=5432
          DB_NAME=testdb
          DB_USER=test
          DB_PASSWORD=test
          SESSION_SECRET=test_session_secret_for_ci
          JWT_SECRET=test_jwt_secret_for_ci
          JWT_EXPIRY=7d
          CORS_ORIGIN=http://localhost:5173,http://localhost:8100
          SWAGGER_USERNAME=admin
          SWAGGER_PASSWORD=test_password
          EOF

          # Verify build output exists
          if [ -d "packages/backend/dist" ] && [ -f "packages/backend/dist/index.js" ]; then
            echo "✅ Backend built successfully!"
            echo "Build artifacts:"
            ls -lh packages/backend/dist/
            echo ""
            echo "Verifying main entry point:"
            head -20 packages/backend/dist/index.js
            exit 0
          else
            echo "❌ Backend build failed - dist directory or index.js not found"
            exit 1
          fi

  # Admin panel build check (main branch version)
  test-admin-panel:
    name: Test Admin Panel Build
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.admin-panel == 'true' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js (Admin Panel)
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build admin panel
        run: |
          # Create minimal .env for testing
          cat > packages/admin-panel/.env << EOF
          API_BASE_URL=http://localhost:3000
          VITE_ENVIRONMENT=development
          EOF
          npm run build:admin

      - name: Verify build output
        run: |
          if [ -d "packages/admin-panel/dist" ]; then
            echo "✅ Admin panel built successfully!"
            echo "Build artifacts:"
            ls -lh packages/admin-panel/dist/
            exit 0
          else
            echo "❌ Admin panel build failed - dist directory not found"
            exit 1
          fi

  # Mobile app build check
  test-mobile-app:
    name: Test Mobile App Build
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.mobile-app == 'true' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js (Mobile App)
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build mobile app web assets
        run: |
          # Create minimal .env for testing
          cat > packages/mobile-app/.env << EOF
          API_BASE_URL=http://localhost:3000
          VITE_ENVIRONMENT=development
          EOF
          npm run build:mobile

      - name: Verify build output
        run: |
          if [ -d "packages/mobile-app/dist" ]; then
            echo "✅ Mobile app built successfully!"
            echo "Build artifacts:"
            ls -lh packages/mobile-app/dist/
            exit 0
          else
            echo "❌ Mobile app build failed - dist directory not found"
            exit 1
          fi

  # Aggregated build/lint/test job
  test-packages:
    name: Full Build, Lint & Test (All Packages)
    runs-on: ubuntu-latest
    # Optionally run always on workflow_dispatch; otherwise can run whenever any package changed.
    needs: detect-changes
    if: github.event_name == 'workflow_dispatch' || needs.detect-changes.outputs.backend == 'true' || needs.detect-changes.outputs.admin-panel == 'true' || needs.detect-changes.outputs.mobile-app == 'true'
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js (Aggregate)
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build packages
        run: npm run build

      - name: Lint packages
        run: npm run lint

      - name: Test packages
        run: npm run test