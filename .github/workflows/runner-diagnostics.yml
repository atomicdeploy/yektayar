name: Runner Diagnostics

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of diagnostic test to run'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - connectivity
          - environment

jobs:
  diagnose-runner:
    runs-on: [self-hosted, linux, yektayar-runners]
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Runner Basic Information
        run: |
          echo "=========================================="
          echo "RUNNER BASIC INFORMATION"
          echo "=========================================="
          echo "Runner Name: $RUNNER_NAME"
          echo "Runner OS: $RUNNER_OS"
          echo "Runner Architecture: $RUNNER_ARCH"
          echo "Runner Temp Directory: $RUNNER_TEMP"
          echo "Runner Tool Cache: $RUNNER_TOOL_CACHE"
          echo "Runner Workspace: $RUNNER_WORKSPACE"
          echo "GitHub Workspace: $GITHUB_WORKSPACE"
          echo ""
      
      - name: System Information
        run: |
          echo "=========================================="
          echo "SYSTEM INFORMATION"
          echo "=========================================="
          echo "Hostname: $(hostname)"
          echo "Kernel: $(uname -r)"
          echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2 | tr -d '\"')"
          echo "Uptime: $(uptime -p)"
          echo ""
          echo "CPU Info:"
          lscpu | grep -E "^(Model name|CPU\(s\)|Thread|Core)"
          echo ""
          echo "Memory Info:"
          free -h
          echo ""
          echo "Disk Usage:"
          df -h / /home
          echo ""
      
      - name: Network Connectivity
        if: inputs.test_type == 'full' || inputs.test_type == 'connectivity'
        run: |
          echo "=========================================="
          echo "NETWORK CONNECTIVITY"
          echo "=========================================="
          echo "Testing GitHub API connectivity..."
          curl -s https://api.github.com/zen || echo "Failed to connect to GitHub API"
          echo ""
          echo "Testing GitHub main site..."
          curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" https://github.com || echo "Failed to connect to GitHub"
          echo ""
          echo "DNS Resolution:"
          nslookup github.com || echo "DNS resolution failed"
          echo ""
      
      - name: Node.js Environment
        run: |
          echo "=========================================="
          echo "NODE.JS ENVIRONMENT"
          echo "=========================================="
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "npm prefix: $(npm prefix)"
          echo "npm global prefix: $(npm config get prefix)"
          echo ""
          echo "Node.js path: $(which node)"
          echo "npm path: $(which npm)"
          echo ""
          echo "Environment PATH:"
          echo "$PATH" | tr ':' '\n'
          echo ""
      
      - name: Java Environment
        run: |
          echo "=========================================="
          echo "JAVA ENVIRONMENT"
          echo "=========================================="
          if command -v java &> /dev/null; then
            echo "Java version:"
            java -version 2>&1
            echo ""
            echo "Java path: $(which java)"
            echo "JAVA_HOME: ${JAVA_HOME:-Not set}"
            if [ -n "$JAVA_HOME" ]; then
              echo "JAVA_HOME contents:"
              ls -la "$JAVA_HOME" 2>/dev/null || echo "JAVA_HOME directory not accessible"
            fi
          else
            echo "❌ Java is not installed or not in PATH"
          fi
          echo ""
      
      - name: Android SDK Environment
        run: |
          echo "=========================================="
          echo "ANDROID SDK ENVIRONMENT"
          echo "=========================================="
          echo "ANDROID_HOME: ${ANDROID_HOME:-Not set}"
          echo "ANDROID_SDK_ROOT: ${ANDROID_SDK_ROOT:-Not set}"
          echo ""
          if [ -n "$ANDROID_HOME" ] && [ -d "$ANDROID_HOME" ]; then
            echo "✓ Android SDK directory exists"
            echo "Android SDK structure:"
            ls -la "$ANDROID_HOME" 2>/dev/null || echo "Cannot list ANDROID_HOME"
            echo ""
            if [ -d "$ANDROID_HOME/cmdline-tools/latest/bin" ]; then
              echo "✓ Command line tools found"
              if command -v sdkmanager &> /dev/null || [ -f "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ]; then
                echo "Installed packages:"
                "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --list_installed 2>/dev/null | head -20 || echo "Cannot list packages"
              fi
            else
              echo "❌ Command line tools not found"
            fi
          else
            echo "❌ ANDROID_HOME not set or directory doesn't exist"
          fi
          echo ""
      
      - name: Build Tools Check
        run: |
          echo "=========================================="
          echo "BUILD TOOLS CHECK"
          echo "=========================================="
          echo "Git version: $(git --version)"
          echo "Git path: $(which git)"
          echo ""
          if command -v gradle &> /dev/null; then
            echo "Gradle version: $(gradle --version | head -3)"
          else
            echo "Gradle: Not in PATH (may be installed with Android SDK)"
          fi
          echo ""
          echo "Make: $(which make 2>/dev/null || echo 'Not installed')"
          echo "Curl: $(which curl 2>/dev/null || echo 'Not installed')"
          echo "Wget: $(which wget 2>/dev/null || echo 'Not installed')"
          echo "Unzip: $(which unzip 2>/dev/null || echo 'Not installed')"
          echo ""
      
      - name: Runner User and Permissions
        run: |
          echo "=========================================="
          echo "RUNNER USER AND PERMISSIONS"
          echo "=========================================="
          echo "Current user: $(whoami)"
          echo "User ID: $(id -u)"
          echo "Group ID: $(id -g)"
          echo "Groups: $(groups)"
          echo ""
          echo "Home directory: $HOME"
          echo "Home directory permissions:"
          ls -la "$HOME" | head -10
          echo ""
          echo "Workspace permissions:"
          ls -la "$GITHUB_WORKSPACE/.." 2>/dev/null | head -10 || echo "Cannot access workspace parent"
          echo ""
      
      - name: GitHub Actions Environment
        run: |
          echo "=========================================="
          echo "GITHUB ACTIONS ENVIRONMENT"
          echo "=========================================="
          echo "GitHub Repository: $GITHUB_REPOSITORY"
          echo "GitHub Ref: $GITHUB_REF"
          echo "GitHub SHA: $GITHUB_SHA"
          echo "GitHub Event: $GITHUB_EVENT_NAME"
          echo "GitHub Actor: $GITHUB_ACTOR"
          echo "GitHub Run ID: $GITHUB_RUN_ID"
          echo "GitHub Run Number: $GITHUB_RUN_NUMBER"
          echo "GitHub Job: $GITHUB_JOB"
          echo "GitHub API URL: $GITHUB_API_URL"
          echo "GitHub Server URL: $GITHUB_SERVER_URL"
          echo ""
      
      - name: Test npm install (Quick)
        if: inputs.test_type == 'quick' || inputs.test_type == 'full'
        run: |
          echo "=========================================="
          echo "NPM INSTALL TEST"
          echo "=========================================="
          echo "Creating test package.json..."
          mkdir -p /tmp/npm-test-$$
          cd /tmp/npm-test-$$
          cat > package.json << 'EOF'
          {
            "name": "runner-test",
            "version": "1.0.0",
            "dependencies": {
              "express": "^4.18.0"
            }
          }
          EOF
          echo "Testing npm install..."
          if npm install --silent; then
            echo "✓ npm install successful"
          else
            echo "❌ npm install failed"
          fi
          cd -
          rm -rf /tmp/npm-test-$$
          echo ""
      
      - name: Test Repository npm install
        if: inputs.test_type == 'full'
        run: |
          echo "=========================================="
          echo "REPOSITORY NPM INSTALL TEST"
          echo "=========================================="
          echo "Testing npm install in repository..."
          npm ci --legacy-peer-deps
          echo "✓ Repository dependencies installed successfully"
          echo ""
      
      - name: Runner Process Information
        run: |
          echo "=========================================="
          echo "RUNNER PROCESS INFORMATION"
          echo "=========================================="
          echo "Runner service status:"
          systemctl status "actions.runner.*" 2>/dev/null | head -20 || echo "Cannot check systemd status (may need sudo)"
          echo ""
          echo "Runner processes:"
          ps aux | grep -E "(Runner.Listener|Runner.Worker)" | grep -v grep || echo "No runner processes found in current view"
          echo ""
      
      - name: Available Storage for Builds
        run: |
          echo "=========================================="
          echo "STORAGE ANALYSIS"
          echo "=========================================="
          echo "Disk space on root:"
          df -h /
          echo ""
          echo "Disk space on home:"
          df -h /home
          echo ""
          echo "Largest directories in runner workspace (if exists):"
          if [ -d "$HOME/actions-runner/_work" ]; then
            du -h --max-depth=2 "$HOME/actions-runner/_work" 2>/dev/null | sort -rh | head -10 || echo "Cannot analyze workspace"
          else
            echo "Workspace directory not found at expected location"
          fi
          echo ""
          echo "Available space for builds:"
          df -h "$RUNNER_TEMP" 2>/dev/null || df -h /tmp
          echo ""
      
      - name: Summary and Recommendations
        run: |
          echo "=========================================="
          echo "DIAGNOSTIC SUMMARY"
          echo "=========================================="
          echo ""
          
          # Check critical components
          ISSUES=0
          
          if ! command -v node &> /dev/null; then
            echo "❌ CRITICAL: Node.js is not installed"
            ISSUES=$((ISSUES + 1))
          else
            echo "✓ Node.js is installed: $(node --version)"
          fi
          
          if ! command -v npm &> /dev/null; then
            echo "❌ CRITICAL: npm is not installed"
            ISSUES=$((ISSUES + 1))
          else
            echo "✓ npm is installed: $(npm --version)"
          fi
          
          if ! command -v java &> /dev/null; then
            echo "⚠ WARNING: Java is not installed (required for Android builds)"
            ISSUES=$((ISSUES + 1))
          else
            echo "✓ Java is installed"
          fi
          
          if [ -z "$ANDROID_HOME" ] || [ ! -d "$ANDROID_HOME" ]; then
            echo "⚠ WARNING: Android SDK not found (required for Android builds)"
            ISSUES=$((ISSUES + 1))
          else
            echo "✓ Android SDK is configured"
          fi
          
          echo ""
          if [ $ISSUES -eq 0 ]; then
            echo "✅ All critical components are properly configured!"
            echo "Runner is ready for all workflow types."
          else
            echo "⚠ Found $ISSUES issue(s) that may affect some workflows."
            echo "Review the diagnostic output above for details."
          fi
          echo ""
          echo "=========================================="
          echo "DIAGNOSTIC COMPLETE"
          echo "=========================================="
